#!/usr/bin/env bash

set -ex

mkdir -p build && cd build

if [ -e linux-src ]; then
   cd linux-src
#   git clean -dfx .
   git clean -dff .
   git checkout -- .
   cd ..
else
   git clone --depth=1 -b rpi-4.19.y https://github.com/raspberrypi/linux.git linux-src
fi

cd linux-src

make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- bcmrpi_defconfig

# sed -iE 's/\(CONFIG_CRYPTO\)\w+=m/\1=y/' .config

make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- LSMOD=../../make/raspi0_lsmod.txt localmodconfig

# sed -i 's/ CONFIG_DEBUG_LL .*/CONFIG_DEBUG_LL=y/' .config
# echo CONFIG_DEBUG_BCM2835=y >> ./.config
# echo CONFIG_EARLY_PRINTK=y >> ./.config

make -j $(nproc) ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf-

touch ../.linux-src
